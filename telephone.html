<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="stylesheet" type="text/css" href="telephone.css"></link>
<link rel="stylesheet" type="text/css" href="libs/flight/css/flightindicators.css" />
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script src="libs/flight/js/jquery.flightindicators.js"></script>
<script src="libs/gyro.js"></script>
<script src="__Capteur.js"></script>
<script>
</script>
<script src="libs/ObjectManager.js"></script>
<script src="libs/views.js"></script>
<style>
	.red {
		color:red;
	}
	.popupWindow{
		background: #fff;
		border: 2px solid #000;
		-webkit-border-radius: 8px;
		border-radius: 8px;
		overflow:hidden;
		padding: 0px;
		width: auto;
		position: fixed;
		font: 12px/16px 'Arial', sans-serif;
	}
	.popupWindowTitlebar {
		background:#ccc;
		height:24px;
		vertical-align:middle;
	}
	.button {
		background:#ccc;
		text-align:center;
		cursor:pointer;
	}
	.button:hover {
		background:#000;
		color:#ccc;
	}
</style>
<body> 
 
</body>
<script>
F.startAutoUpdate();
F.defineProperty("Application", "nomTemporaire");
F.defineProperty("Application", "nom");
F.defineProperty("Application", "telephone");
app.lastCommit = Date.now();
app.lastChange = Date.now();
app.isChanging = false;
app.isCommiting = false;
app.firstAlpha = null;
app.firstBeta = null;

navigator.vibrate = navigator.vibrate || navigator.webkitVibrate || navigator.mozVibrate || navigator.msVibrate;

header = function() {
	return  FV.tag("div",{},[
			FV.tag("h2",{width:"auto",textAlign:"center"},function(){return (app.nom != null && app.nom != "" ? "Sensor/Actuator Simulator of " + app.nom : "Enter your name");}),
	])
};

F.defineTrigger(function(){
	if(app.nom != null && !app.telephone){
		app.getOrCreateTelephone({"nom":app.nom},
					function(retourServeur){app.telephone =  retourServeur;},
					function(){app.telephone =  F.create("Telephone", {nom: app.nom,beta:0.0, alpha:0.0} );}
					);
	}
});

F.defineTrigger(function(){
	if(app.telephone != null){
		navigator.vibrate(app.telephone.vibre ? 5000 : 0);
	}
});

defineName = function(){
	return FV.tag("input", {visibility:function(){return (app.telephone != null) ? "hidden" : "visible"}, type:"FvText",forsObject:app,forsProperty:"nomTemporaire"});
};
divGauge = function(){return FV.tag("div", {visibility:function(){return (app.telephone == null) ? "hidden" : "visible"}}, gauge);};
var gauge = FV.tag("span", {id:"attitude", visibility:function(){return (app.telephone == null) ? "hidden" : "visible"}});



if(window.DeviceOrientationEvent){
	window.addEventListener('deviceorientation', function(){
		if(app.telephone != null && !app.isChanging && Date.now() - app.lastChange > 20){
			var gyr = gyro.getOrientation();
			var alpha = parseFloat(gyr.alpha);
			var beta = parseFloat(gyr.beta);
			if(app.firstAlpha == null) app.firstAlpha = alpha;
			if(app.firstBeta == null) app.firstBeta = beta;
			attitude.setRoll(-app.firstAlpha + alpha);
   			attitude.setPitch(-app.firstBeta + beta);
			commitSiNecessaire(alpha, beta);
		}
	})
}


page =  FV.tag("div",{},[
		FV.tag("div",{},header()),
		divGauge(),
		defineName(),
		FV.tag("button", {
			"background":function(){if(app.telephone == null) return "darkgray"; else return app.telephone.vibre ? "red" : "lightGreen"},
			"onclick":function(){if(app.telephone == null) {app.nom = app.nomTemporaire; return;} app.telephone.vibre=!app.telephone.vibre; F.commit();}
			}, 
			function(){if(app.telephone == null)return "not enregistred yet !";return  app.telephone.vibre ? "Stop !" : "Move !"}
		)
	]
);

document.body.appendChild(page.domElt);
var attitude = $.flightIndicator("#attitude", 'attitude', {size:400});

commitSiNecessaire = function(alpha, beta){
	if(!app.isCommiting && Date.now() - app.lastCommit > 1000){
		app.isCommiting = true;
		app.telephone.alpha = alpha;
		app.telephone.beta = beta;	
		F.commit(function(){app.isCommiting = false; app.lastCommit = Date.now();});
	}
};
</script>
